<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triangle wave MIDI Player</title>
    <script src="https://cdn.jsdelivr.net/npm/midi-parser-js@4.0.4/src/main.min.js"></script>
    <style>
        :root { --accent: #00f2fe; --bg: #0a0a12; --panel: #16162d; --eq-color: #ffb86c; --bg-play-color: #50fa7b; }
        body { font-family: 'Consolas', monospace; background: var(--bg); color: var(--accent); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 380px 1fr; gap: 20px; }
        .panel { background: var(--panel); border: 1px solid #2a2a4d; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { grid-column: span 2; text-align: center; letter-spacing: 5px; margin: 10px 0 20px; font-weight: bold; text-shadow: 0 0 10px var(--accent); }
        
        .group { background: #1f1f3a; padding: 12px; border-radius: 8px; margin-bottom: 12px; border: 1px solid #333; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
        
        .num-in { background: #000; color: var(--accent); border: 1px solid #444; border-radius: 4px; padding: 2px 5px; width: 65px; text-align: right; font-family: inherit; }
        .eq-in { color: var(--eq-color); border-color: #554433; }

        .btn-row { display: flex; gap: 5px; margin-top: 5px; }
        button { flex: 1; background: #2d2d4d; color: white; border: 1px solid #444; padding: 8px; cursor: pointer; font-weight: bold; font-family: inherit; transition: 0.2s; border-radius: 4px; }
        button:hover { background: #3d3d6d; border-color: var(--accent); }
        button.active { background: #ff007f; border-color: #ff007f; }
        
        #bgPlayBtn.active { background: var(--bg-play-color); color: #000; border-color: var(--bg-play-color); }
        .play-btn { background: var(--accent); color: #000; font-size: 1.1rem; }

        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        .eq-range { accent-color: var(--eq-color) !important; }

        .mixer-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; margin-bottom: 20px; }
        .ch { background: #0a0a1a; padding: 8px 2px; border-radius: 4px; text-align: center; border: 1px solid #222;}
        .v-slider { appearance: slider-vertical; height: 70px; width: 10px; margin: 5px 0; }
        .ind { width: 6px; height: 6px; background: #333; border-radius: 50%; margin: 0 auto 5px; }
        .ind.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }

        .eq-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; border-top: 2px solid #333; padding-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Triangle Wave MIDI Player</h1>

    <div class="panel">
        <input type="file" id="fileInput" accept=".mid,.midi" style="margin-bottom:15px; width:100%;">
        
        <div class="group">
            <div class="label-row"><span>TIME (sec)</span><input type="number" id="timeInput" class="num-in" value="0"></div>
            <div class="label-row"><span id="timeDisplay">0:00 / 0:00</span></div>
            <input type="range" id="progressRange" min="0" max="100" value="0" step="0.1">
        </div>

        <button id="playBtn" class="play-btn" style="width:100%; margin-bottom:8px;" disabled>PLAY</button>
        <div class="btn-row" style="margin-bottom:15px;">
            <button id="pauseBtn">PAUSE</button>
            <button id="resetBtn">RESET</button>
        </div>

        <div class="group" style="border-left: 4px solid var(--bg-play-color);">
            <button id="bgPlayBtn">BG PLAY: OFF</button>
        </div>

        <div class="group">
            <div class="label-row"><span>VOLUME</span><input type="number" id="volNum" class="num-in" value="0.7" step="0.05"></div>
            <input type="range" id="volRange" min="0" max="1" step="0.01" value="0.7">
        </div>

        <div class="group">
            <div class="label-row"><span>TEMPO (x)</span><input type="number" id="tempoNum" class="num-in" value="1.00" step="0.05"></div>
            <input type="range" id="tempoRange" min="0.2" max="3.0" step="0.01" value="1.00">
            
            <div class="label-row" style="margin-top:10px;"><span>PITCH (Semi)</span><input type="number" id="pitchNum" class="num-in" value="0" step="1"></div>
            <input type="range" id="pitchRange" min="-12" max="12" step="1" value="0">
        </div>

        <select id="waveSelect" class="group" style="width:100%">
            <option value="triangle">Triangle</option><option value="sine">Sine</option>
            <option value="square">Square</option><option value="sawtooth">Sawtooth</option>
        </select>
        <div class="btn-row">
            <button id="loopBtn">LOOP: OFF</button>
            <button id="modeBtn">STEREO</button>
        </div>
    </div>

    <div class="panel">
        <h2 style="font-size: 0.9rem; margin-top:0; border-bottom:1px solid #333; padding-bottom:5px;">CHANNEL MIXER</h2>
        <div id="mixerGrid" class="mixer-grid"></div>

        <h2 style="font-size: 0.9rem; color: var(--eq-color); border-bottom:1px solid #443322; padding-bottom:5px;">MASTER EQUALIZER</h2>
        <div class="eq-panel">
            <div class="group" style="margin-bottom:0">
                <div class="label-row" style="color:var(--eq-color)"><span>BASS</span></div>
                <input type="range" id="eqBassRange" class="eq-range" min="-20" max="20" value="0">
                <input type="number" id="eqBassNum" class="num-in eq-in" value="0" style="width:100%; margin-top:5px;">
            </div>
            <div class="group" style="margin-bottom:0">
                <div class="label-row" style="color:var(--eq-color)"><span>MID</span></div>
                <input type="range" id="eqMidRange" class="eq-range" min="-20" max="20" value="0">
                <input type="number" id="eqMidNum" class="num-in eq-in" value="0" style="width:100%; margin-top:5px;">
            </div>
            <div class="group" style="margin-bottom:0">
                <div class="label-row" style="color:var(--eq-color)"><span>TREBLE</span></div>
                <input type="range" id="eqTrebleRange" class="eq-range" min="-20" max="20" value="0">
                <input type="number" id="eqTrebleNum" class="num-in eq-in" value="0" style="width:100%; margin-top:5px;">
            </div>
        </div>
        <div id="status" style="margin-top:15px; font-size:0.75rem; color:#666;">Waiting for MIDI...</div>
    </div>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // --- EQ Setup ---
    const bassFilter = audioCtx.createBiquadFilter(); bassFilter.type = "lowshelf"; bassFilter.frequency.value = 100;
    const midFilter = audioCtx.createBiquadFilter(); midFilter.type = "peaking"; midFilter.frequency.value = 1000; midFilter.Q.value = 1;
    const trebleFilter = audioCtx.createBiquadFilter(); trebleFilter.type = "highshelf"; trebleFilter.frequency.value = 2500;
    
    const masterGain = audioCtx.createGain();
    // Chain: Filters -> MasterGain -> Destination
    bassFilter.connect(midFilter);
    midFilter.connect(trebleFilter);
    trebleFilter.connect(masterGain);
    masterGain.connect(audioCtx.destination);

    // --- Worker Setup ---
    const workerBlob = new Blob([`
        let timer = null;
        self.onmessage = function(e) {
            if (e.data === 'start') { if(!timer) timer = setInterval(() => self.postMessage('tick'), 50); }
            else if (e.data === 'stop') { clearInterval(timer); timer = null; }
        };
    `], { type: 'text/javascript' });
    const worker = new Worker(URL.createObjectURL(workerBlob));

    // Sync Helper
    function sync(sliderId, numId, nodeParam) {
        const s = document.getElementById(sliderId), n = document.getElementById(numId);
        const update = (v) => { 
            n.value = v; s.value = v; 
            if(nodeParam instanceof AudioParam) nodeParam.setTargetAtTime(v, audioCtx.currentTime, 0.02);
        };
        s.oninput = () => update(s.value); n.oninput = () => update(n.value);
    }

    sync('volRange', 'volNum', masterGain.gain);
    sync('tempoRange', 'tempoNum', null);
    sync('pitchRange', 'pitchNum', null);
    sync('eqBassRange', 'eqBassNum', bassFilter.gain);
    sync('eqMidRange', 'eqMidNum', midFilter.gain);
    sync('eqTrebleRange', 'eqTrebleNum', trebleFilter.gain);

    let musicData = [], isPlaying = false, isPaused = false, isLooping = false, isStereo = true, isBgPlay = false;
    let startTime = 0, pausedTime = 0, currentIndex = 0, totalDuration = 0, animId = null;
    const chSettings = Array.from({length: 16}, () => ({ vol: 0.5 }));

    // Mixer Init
    const mixerGrid = document.getElementById('mixerGrid');
    for(let i=0; i<16; i++) {
        const div = document.createElement('div'); div.className = 'ch';
div.innerHTML = `
    <div class="ind" id="ind-${i}"></div>
    <input type="range" class="v-slider" id="vs-${i}" min="0" max="1" step="0.01" value="0.5">
    <input type="number" id="vn-${i}" class="num-in" value="0.5" step="0.05" min="0" max="1" 
           style="width: 35px; font-size: 0.6rem; padding: 1px; margin-bottom: 5px;">
    <div style="font-size:0.5rem">CH${i+1}</div>`;
        mixerGrid.appendChild(div);
const slider = div.querySelector(`#vs-${i}`);
const number = div.querySelector(`#vn-${i}`);

const updateVol = (val) => {
    val = Math.max(0, Math.min(1, parseFloat(val) || 0));
    chSettings[i].vol = val;
    slider.value = val;
    number.value = val.toFixed(2);
};

slider.oninput = (e) => updateVol(e.target.value);
number.oninput = (e) => updateVol(e.target.value);
    }

    const formatTime = (s) => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
    
    function seekTo(target) {
        pausedTime = Math.max(0, Math.min(target, totalDuration));
        startTime = audioCtx.currentTime;
        currentIndex = musicData.findIndex(n => n.t >= pausedTime);
        if(currentIndex === -1) currentIndex = musicData.length;
        document.getElementById('progressRange').value = pausedTime;
    }

    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const midi = MidiParser.parse(new Uint8Array(ev.target.result));
            musicData = [];
            midi.track.forEach(track => {
                let ticks = 0, active = {};
                track.event.forEach(ev => {
                    ticks += ev.deltaTime;
                    let n = ev.data ? ev.data[0] : null;
                    if(ev.type === 9 && ev.data[1] > 0) active[n] = {t: ticks, v: ev.data[1]};
                    else if(active[n] && (ev.type === 8 || (ev.type === 9 && ev.data[1] === 0))) {
                        musicData.push({n:n, t:(active[n].t/midi.timeDivision)*0.5, d:((ticks-active[n].t)/midi.timeDivision)*0.5, ch:ev.channel, vel:active[n].v/127});
                        delete active[n];
                    }
                });
            });
            musicData.sort((a,b) => a.t - b.t);
            totalDuration = musicData.length ? Math.max(...musicData.map(d=>d.t+d.d)) : 0;
            document.getElementById('progressRange').max = totalDuration;
            document.getElementById('playBtn').disabled = false;
            document.getElementById('status').innerText = `Loaded: ${musicData.length} notes.`;
            seekTo(0);
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function playTone(note, time, dur, ch, vel) {
        const speed = parseFloat(document.getElementById('tempoNum').value);
        const pitchShift = parseInt(document.getElementById('pitchNum').value);
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        const p = audioCtx.createStereoPanner();
        
        osc.type = document.getElementById('waveSelect').value;
        osc.frequency.setValueAtTime(440 * Math.pow(2, (note + pitchShift - 69)/12), time);
        p.pan.value = isStereo ? (ch % 2 === 0 ? -0.4 : 0.4) : 0;
        
        const realDur = dur / speed;
        const v = chSettings[ch].vol * vel * 0.2;
        
        g.gain.setValueAtTime(0, time);
        g.gain.linearRampToValueAtTime(v, time + 0.01);
        g.gain.linearRampToValueAtTime(0, time + realDur);

        osc.connect(g).connect(p).connect(bassFilter); // Start of EQ Chain
        osc.start(time); osc.stop(time + realDur);
        
        setTimeout(() => {
            const ind = document.getElementById(`ind-${ch}`);
            if(ind && isPlaying && !isPaused) { 
                ind.classList.add('active'); 
                setTimeout(()=>ind.classList.remove('active'), 60); 
            }
        }, Math.max(0, (time - audioCtx.currentTime)*1000));
    }

    function schedule() {
        if(!isPlaying || isPaused) return;
        const speed = parseFloat(document.getElementById('tempoNum').value);
        const now = (audioCtx.currentTime - startTime) * speed + pausedTime;
        
        document.getElementById('progressRange').value = now;
        document.getElementById('timeDisplay').innerText = `${formatTime(now)} / ${formatTime(totalDuration)}`;

        while(currentIndex < musicData.length && musicData[currentIndex].t < now + 0.2) {
            const d = musicData[currentIndex];
            playTone(d.n, (d.t - pausedTime)/speed + startTime, d.d, d.ch, d.vel);
            currentIndex++;
        }
        
        if(now >= totalDuration) { if(isLooping) seekTo(0); else { isPlaying = false; worker.postMessage('stop'); } }
        if (!isBgPlay) animId = requestAnimationFrame(schedule);
    }

    worker.onmessage = () => { if(isBgPlay) schedule(); };

    document.getElementById('playBtn').onclick = () => {
        audioCtx.resume(); isPlaying = true; isPaused = false; 
        startTime = audioCtx.currentTime;
        if(isBgPlay) worker.postMessage('start');
        schedule();
    };

    document.getElementById('bgPlayBtn').onclick = function() {
        isBgPlay = !isBgPlay;
        this.classList.toggle('active');
        this.innerText = `BG PLAY: ${isBgPlay ? 'ON' : 'OFF'}`;
        if(isPlaying && !isPaused) {
            if(isBgPlay) { cancelAnimationFrame(animId); worker.postMessage('start'); }
            else { worker.postMessage('stop'); schedule(); }
        }
    };

    document.getElementById('pauseBtn').onclick = function() { 
        if(!isPlaying) return;
        isPaused = !isPaused;
        if(isPaused) { 
            pausedTime += (audioCtx.currentTime - startTime)*parseFloat(document.getElementById('tempoNum').value); 
            cancelAnimationFrame(animId); worker.postMessage('stop'); this.innerText="RESUME"; 
        } else { 
            startTime = audioCtx.currentTime; this.innerText="PAUSE"; 
            if(isBgPlay) worker.postMessage('start'); else schedule();
        }
    };

    document.getElementById('resetBtn').onclick = () => { seekTo(0); if(!isPlaying) document.getElementById('playBtn').click(); };
    document.getElementById('progressRange').oninput = (e) => seekTo(parseFloat(e.target.value));
    document.getElementById('loopBtn').onclick = function() { isLooping = !isLooping; this.classList.toggle('active'); this.innerText = `LOOP: ${isLooping?'ON':'OFF'}`; };
    document.getElementById('modeBtn').onclick = function() { isStereo = !isStereo; this.innerText = isStereo ? "STEREO" : "MONO"; };

</script>
</body>
</html>
